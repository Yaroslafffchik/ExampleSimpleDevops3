user nginx; # запускаем воркеры от имени пользователя nginx
worker_processes auto; # число процессов, обычно равно числу CPU
error_log /var/log/nginx/error.log warn; # лог ошибок с уровнем warn
pid /var/run/nginx.pid; # файл с PID мастера

events {
    worker_connections 1024; # достаточно для учебного проекта
}
http {
    include /etc/nginx/mime.types; # файл с mimes
    default_type application/octet-stream; # бинарный по умолчанию

    sendfile on; # используем sendfile при отсылке файлов
    tcp_nopush on; # оптимизация для sendfile
    keepalive_timeout 65; # таймаут для keep-alive соединений в секундах
    client_max_body_size 10M; # максимальный размер тела запроса (на случай загрузок)

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                     '$status $body_bytes_sent "$http_referer" '
                     '"$http_user_agent" "$http_x_forwarded_for"';

    map $http_upgrade $connection_upgrade {
        default upgrade; # если есть upgrade -> использовать upgrade
        ""      close;   # если нет -> закрывать соединение
    }

    upstream service1_up {
        server service1:8080 max_fails=3 fail_timeout=30s; # если не отвечает, пометим как упавший
        keepalive 16; # количество персистентных соединений к бэкэнду
    }

    upstream service2_up {
        server service2:8080 max_fails=3 fail_timeout=30s; # бэкенд для service2
        keepalive 16; # пул соединений
    }

    server {
        listen 80; # слушаем порт 80 внутри контейнера
        server_name devops_3; # имя сервера (для локальной учебной конфигурации можно любое)

        location /service1/ {
            proxy_pass http://service1_up/; # проксируем на upstream, сохраняем относительный путь

            proxy_set_header Host $host; # передаём оригинальный Host
            proxy_set_header X-Real-IP $remote_addr; # ip клиента
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # цепочка IP
            proxy_set_header X-Forwarded-Proto $scheme; # http или https

            proxy_http_version 1.1; # используем HTTP/1.1 при проксировании
            proxy_set_header Upgrade $http_upgrade; # поддержка websocket upgrade
            proxy_set_header Connection $connection_upgrade; # connection: upgrade/close

            proxy_read_timeout 90s; # секунда ожидания ответа
        }


        location /service2/ {
            proxy_pass http://service2_up/; # проксируем на service2

            proxy_set_header Host $host; # передаём оригинальный Host
            proxy_set_header X-Real-IP $remote_addr; # ip клиента
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # цепочка IP
            proxy_set_header X-Forwarded-Proto $scheme; # протокол клиента

            proxy_http_version 1.1; # http/1.1
            proxy_set_header Upgrade $http_upgrade; # websocket upgrade
            proxy_set_header Connection $connection_upgrade; # connection header
            proxy_read_timeout 90s; # таймаут чтения ответа
        }
    }
}
